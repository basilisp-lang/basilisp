(ns tests.basilisp.test-cli-tools
  (:require
   [basilisp.cli-tools :as cli]
   [basilisp.test :refer [deftest are is testing]]))

(def ^:private base-parser-config
  {:command      "command"
   :description  "This command foos the bars."
   :allow-abbrev true
   :arguments    []
   :commands     []})

(def ^:private base-arg-config
  {:name     "foo"
   :parse-fn int
   :validate [pos? "foo must be positive"]
   :default  "yes"
   :metavar  "FOO"
   :help     "Add extra foos into the bars."})

(def ^:private base-flag-config
  {:flags    ["-f" "--foo"]
   :parse-fn int
   :validate [pos? "foo must be positive"]
   :default  "yes"
   :metavar  "FOO"
   :help     "Add extra foos into the bars."})

(deftest cli-parser-spec-validation
  (testing "disallow name and flags"
    (is (thrown? basilisp.lang.exception/ExceptionInfo
                 (-> base-arg-config
                     (assoc :flags ["-f" "--foo"])
                     (->> (update base-parser-config :arguments conj))
                     (cli/cli-parser)))))

  (testing "disallow assoc-fn and update-fn"
    (is (thrown? basilisp.lang.exception/ExceptionInfo
                 (-> base-arg-config
                     (assoc :assoc-fn assoc :update-fn (fnil inc 0))
                     (->> (update base-parser-config :arguments conj))
                     (cli/cli-parser)))))

  (testing "disallow exclusive-group and group"
    (is (thrown? basilisp.lang.exception/ExceptionInfo
                 (-> base-arg-config
                     (assoc :group :foos :exclusive-group :bars)
                     (->> (update base-parser-config :arguments conj))
                     (cli/cli-parser))))))

(defn parse-args
  [parser args]
  (try
    (cli/parse-args parser args)
    (catch python/SystemExit _ nil)))

(deftest cli-parser
  (let [parser (cli/cli-parser
                {:command     "basilisp"
                 :description "Basilisp is a Lisp dialect inspired by Clojure targeting Python 3"
                 :arguments   []
                 :commands    [{:command     "run"
                                :description "Run a Basilisp script from a file or run Basilisp code directly."
                                :help        "run a Basilisp script or code"
                                :handler     identity
                                :arguments   [{:name "file-or-code"
                                               :help "the filename or, if using -c the code, to execute"}
                                              {:flags   ["--in-ns"]
                                               :help    "namespace to run the code in"
                                               :default "basilisp.user"}
                                              {:flags     ["-c" "--code"]
                                               :help      "if provided, treat argument as a string of code"
                                               :default   false
                                               :update-fn (constantly true)}

                                              {:flags ["--warn-on-shadowed-name"]
                                               :help  "if provided, emit warnings if a local name is shadowed by another local name"
                                               :nargs 0
                                               :env   "BASILISP_WARN_ON_SHADOWED_NAME"
                                               :group "compiler flags"}
                                              {:flags ["--warn-on-shadowed-var"]
                                               :help  "if provided, emit warnings if a Var name is shadowed by a local name"
                                               :nargs 0
                                               :env   "BASILISP_WARN_ON_SHADOWED_VAR"
                                               :group "compiler flags"}]}]})]
    (are [args ret] (is (= ret (dissoc (parse-args parser args) :handler)))
      []                                                     {}
      ["run" "--in-ns" "basilisp.cli-tools" "cli_tools.lpy"] {:file-or-code          "cli_tools.lpy"
                                                              :code                  false
                                                              :in-ns                 "basilisp.cli-tools"
                                                              :warn-on-shadowed-var  nil
                                                              :warn-on-shadowed-name nil}
      ["run" "--warn-on-shadowed-name" "-c" "(identity 1)"]  {:file-or-code          "(identity 1)"
                                                              :code                  true
                                                              :in-ns                 "basilisp.user"
                                                              :warn-on-shadowed-var  nil
                                                              :warn-on-shadowed-name true}
      ["run" "--code" "(identity 1)"]                        {:file-or-code          "(identity 1)"
                                                              :code                  true
                                                              :in-ns                 "basilisp.user"
                                                              :warn-on-shadowed-var  nil
                                                              :warn-on-shadowed-name nil})))
