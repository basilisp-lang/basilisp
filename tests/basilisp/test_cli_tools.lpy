(ns tests.basilisp.test-cli-tools
  (:require
   [basilisp.cli-tools :as cli]
   [basilisp.test :refer [deftest are is testing]]))

(def ^:private base-parser-config
  {:command      "command"
   :description  "This command foos the bars."
   :allow-abbrev true
   :arguments    []
   :commands     []})

(def ^:private base-arg-config
  {:name     "foo"
   :parse-fn int
   :validate [pos? "foo must be positive"]
   :default  "yes"
   :metavar  "FOO"
   :help     "Add extra foos into the bars."})

(def ^:private base-flag-config
  {:flags    ["-f" "--foo"]
   :parse-fn int
   :validate [pos? "foo must be positive"]
   :default  "yes"
   :metavar  "FOO"
   :help     "Add extra foos into the bars."})

(deftest cli-parser-spec-validation
  (testing "disallow name and flags"
    (is (thrown? basilisp.lang.exception/ExceptionInfo
                 (-> base-arg-config
                     (assoc :flags ["-f" "--foo"])
                     (->> (update base-parser-config :arguments conj))
                     (cli/cli-parser)))))

  (testing "disallow assoc-fn and update-fn"
    (is (thrown? basilisp.lang.exception/ExceptionInfo
                 (-> base-arg-config
                     (assoc :assoc-fn assoc :update-fn (fnil inc 0))
                     (->> (update base-parser-config :arguments conj))
                     (cli/cli-parser)))))

  (testing "disallow exclusive-group and group"
    (is (thrown? basilisp.lang.exception/ExceptionInfo
                 (-> base-arg-config
                     (assoc :group :foos :exclusive-group :bars)
                     (->> (update base-parser-config :arguments conj))
                     (cli/cli-parser))))))
