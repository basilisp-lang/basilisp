(ns tests.basilisp.core-fns-test
  (:require
   [basilisp.test :refer [deftest are is testing]]))

(deftest reduce-kv-test
  (testing "reduce-kv does not execute f if no elems in coll"
    (let [a (atom false)]
      (is (= {:init true}
             (reduce-kv (fn [_ _ _]
                          (reset! a true))
                        {:init true}
                        [])))))

  (testing "reduce-kv"
    (is (= {1 :a, 2 :b, 3 :c}
           (reduce-kv #(assoc %1 %3 %2) {} {:a 1 :b 2 :c 3})))))

(deftest every-pred-test
  (is (= true ((every-pred odd?) 3 5 9)))
  (is (= true ((every-pred odd? int?) 3 5 9 17)))
  (is (= false ((every-pred odd? neg? int?) -3 -2)))
  (is (= false ((every-pred odd? neg? int?) -3 -1 7)))
  (is (= false ((every-pred odd? neg? int?) -3 -1 -3.0))))

(deftest some-fn-test
  (is (= 1 ((some-fn :a) {:a 1 :c 2})))
  (is (= 1 ((some-fn :a :b) {:a 1 :c 2})))
  (is (= 2 ((some-fn :a :b :c) {:d 4} {:c 2})))
  (is (= nil ((some-fn :a :b :c) {})))
  (is (= nil ((some-fn :a :b :c) {:e 5} {:d 4})))
  (is (= nil ((some-fn :a :b :c) {:e 5 :d 4} {}))))

(deftest keep-test
  (is (= '() (keep identity [])))
  (is (= '(:a :b :c) (keep identity [:a :b :c])))
  (is (= '(:a :b :c) (keep identity [:a :b nil :c])))
  (is (= '(:a :b :c) (keep identity [:a :b nil nil :c])))
  (is (= '(:a :b :c :d) (keep identity [:a :b nil :c nil nil :d]))))

(deftest keep-indexed-test
  (let [f (fn [i v] v)]
    (is (= '() (keep-indexed f [])))
    (is (= '(:a :b :c) (keep-indexed f [:a :b :c])))
    (is (= '(:a :b :c) (keep-indexed f [:a :b nil :c])))
    (is (= '(:a :b :c) (keep-indexed f [:a :b nil nil :c])))
    (is (= '(:a :b :c :d) (keep-indexed f [:a :b nil :c nil nil :d])))))

(deftest interleave-test
  (is (= '() (interleave)))
  (is (= '(1 2 3) (interleave [1 2 3])))
  (is (= '(1 :a 2 :b 3 :c) (interleave [1 2 3] [:a :b :c])))
  (is (= '(1 :a d 2 :b e 3 :c f)
         (interleave [1 2 3] [:a :b :c] ['d 'e 'f])))
  (is (= '(1 :a d 2 :b e)
         (interleave [1 2 3] [:a :b] ['d 'e 'f]))))

(deftest min-key-test
  (is (= "dsd" (max-key count "asd" "bsd" "dsd")))
  (is (= "long word" (max-key count "asd" "bsd" "dsd" "long word")))
  (is (= "long word" (max-key count "long word" "asd" "bsd" "dsd"))))

(deftest max-key-test
  (is (= "dsd" (min-key count "asd" "bsd" "dsd")))
  (is (= "dsd" (min-key count "asd" "bsd" "dsd" "long word")))
  (is (= "a" (min-key count "a" "bsd" "dsd" "long word"))))

(deftest sort-by-test
  (testing "no cmp function"
    (is (= '() (sort-by count [])))
    (is (= '([:a] [5 5] [1 2 3])
           (sort-by count [[1 2 3] [:a] [5 5]]))))

  (testing "with cmp function"
    (let [cmp (fn [v1 v2] (- v2 v1))]
      (is (= '() (sort-by count cmp [])))
      (is (= '([1 2 3] [5 5] [:a])
             (sort-by count cmp [[1 2 3] [:a] [5 5]]))))))

(deftest trampoline-test
  (let [a (atom [])]
    (trampoline (fn [v]
                  (swap! a conj :a)
                  (fn []
                    (swap! a conj :b)))
                "idiot")
    (is (= [:a :b] @a))))

(deftest replace-test
  (is (= '(This is the code ZERO ONE TWO ZERO)
         (replace '{0 ZERO, 1 ONE, 2 TWO} '(This is the code 0 1 2 0))))
  (is (= [:four :two :four :two]
         (replace {2 :two, 4 :four} [4 2 3 4 5 6 2])))
  (is (= [10 8 6]
         (replace [10 9 8 7 6] [0 2 4])))
  (is (= [:zeroth :second :fourth :zeroth]
         (replace [:zeroth :first :second :third :fourth] [0 2 4 0]))))
