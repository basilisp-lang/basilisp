(ns tests.basilisp.core.test-taps
  (:require
   [basilisp.test :refer [deftest is]]))

(deftest tap-test
  (let [tap-queue (var-get (find-var 'basilisp.core/tap-queue))

        def-atom (atom [])
        a1-atom  (atom [])
        a2-atom  (atom [])
        b-atom   (atom [])

        def-fn   #(swap! def-atom conj %)
        a1-fn    #(swap! a1-atom conj [:a1 %])
        a2-fn    #(swap! a2-atom conj [:a2 %])
        b-fn     #(swap! b-atom conj %)]
    (add-tap def-fn)
    (remove-tap b-fn)  ;; not an error
    (tap> "this is a test")

    ;; Wait for the tap thread to drain
    (.join tap-queue)

    (remove-tap def-fn)
    (tap> "this is not a test")

    (is (= ["this is a test"] @def-atom))
    (is (= [] @a1-atom))
    (is (= [] @a2-atom))
    (is (= [] @b-atom))

    (add-tap :a a1-fn)
    (add-tap :a a2-fn)
    (tap> :a "all a's get this value")
    (tap> :a "and this one!")
    (.join tap-queue)
    (remove-tap :a a2-fn)
    (tap> :a "but this is just for the top a")
    (.join tap-queue)

    (is (= ["this is a test"] @def-atom))
    (is (= [[:a1 "all a's get this value"]
            [:a1 "and this one!"]
            [:a1 "but this is just for the top a"]]
           @a1-atom))
    (is (= [[:a2 "all a's get this value"]
            [:a2 "and this one!"]]
           @a2-atom))
    (is (= [] @b-atom))))
